<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>GeoMaterial Connect</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" rel="stylesheet" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        :root {
            --md-sys-color-primary: #2D6A4F;
            --md-sys-color-on-primary: #ffffff;
            --md-sys-color-primary-container: #D2E8D4;
            --md-sys-color-on-primary-container: #002111;
            --md-sys-color-surface: #F7FBF2;
            --md-sys-color-surface-variant: #DEE5DA;
            --md-sys-color-on-surface: #191C19;
            --md-sys-color-error: #BA1A1A;
            --md-elevation-2: 0px 2px 6px 2px rgba(0,0,0,0.15);
        }

        [data-theme="ocean"] { --md-sys-color-primary: #006494; --md-sys-color-primary-container: #CBE6FF; --md-sys-color-surface: #F8F9FF; --md-sys-color-surface-variant: #DEE3EB; }
        [data-theme="volcano"] { --md-sys-color-primary: #9C4331; --md-sys-color-primary-container: #FFDAD3; --md-sys-color-surface: #FFFBFF; --md-sys-color-surface-variant: #F5DDD9; }

        * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; }
        html, body { margin: 0; padding: 0; height: 100%; width: 100%; overflow: hidden; background-color: var(--md-sys-color-surface-variant); }
        body { font-family: 'Roboto', sans-serif; display: flex; flex-direction: column; padding-top: env(safe-area-inset-top); }

        header { height: 64px; display: flex; align-items: center; padding: 0 20px; background-color: var(--md-sys-color-surface); z-index: 100; flex-shrink: 0; }
        header h1 { font-size: 20px; font-weight: 500; margin-left: 12px; color: var(--md-sys-color-on-surface); flex-grow: 1; }

        #content-area { flex-grow: 1; position: relative; overflow: hidden; background: var(--md-sys-color-surface); }
        .view { position: absolute; inset: 0; display: none; flex-direction: column; background: var(--md-sys-color-surface); overflow-y: auto; -webkit-overflow-scrolling: touch; }
        .view.active { display: flex; }

        #map { height: 100%; width: 100%; z-index: 1; }

        nav {
            background-color: var(--md-sys-color-surface-variant);
            display: flex; justify-content: space-around; align-items: center;
            padding-bottom: env(safe-area-inset-bottom);
            min-height: calc(65px + env(safe-area-inset-bottom));
            border-top: 1px solid rgba(0,0,0,0.05); z-index: 100;
        }

        .nav-btn { display: flex; flex-direction: column; align-items: center; gap: 4px; color: #444; font-size: 11px; flex: 1; cursor: pointer; border: none; background: none; padding: 10px 0; }
        .nav-btn.active { color: var(--md-sys-color-primary); font-weight: 700; }
        .nav-icon-wrapper { width: 56px; height: 32px; border-radius: 20px; display: flex; align-items: center; justify-content: center; }
        .nav-btn.active .nav-icon-wrapper { background-color: var(--md-sys-color-primary-container); }

        .fab-container { position: absolute; right: 20px; bottom: calc(20px + env(safe-area-inset-bottom)); display: flex; flex-direction: column; gap: 15px; z-index: 10; }
        .fab { width: 56px; height: 56px; background-color: var(--md-sys-color-primary); color: white; border-radius: 18px; border: none; display: flex; align-items: center; justify-content: center; box-shadow: var(--md-elevation-2); }

        .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 1000; display: none; align-items: flex-end; justify-content: center; backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px); }
        .overlay.show { display: flex; }
        .modal { 
            background: var(--md-sys-color-surface); width: 100%; max-width: 550px; 
            border-radius: 28px 28px 0 0; padding: 25px; 
            padding-bottom: calc(25px + env(safe-area-inset-bottom));
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn { from { transform: translateY(100%); } to { transform: translateY(0); } }

        .m3-field { width: 100%; background: var(--md-sys-color-surface-variant); border: none; padding: 16px; border-radius: 15px; margin-bottom: 12px; font-size: 16px; font-family: inherit; }
        .btn-main { background: var(--md-sys-color-primary); color: white; border: none; width: 100%; padding: 16px; border-radius: 100px; font-weight: 600; }

        .switch { position: relative; display: inline-block; width: 52px; height: 32px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; inset: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 24px; width: 24px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--md-sys-color-primary); }
        input:checked + .slider:before { transform: translateX(20px); }

        #status-bar {
            position: absolute; top: 15px; left: 50%; transform: translateX(-50%) translateY(-150%);
            background: var(--md-sys-color-primary); color: white; padding: 12px 24px;
            border-radius: 100px; z-index: 1001; display: flex; align-items: center; gap: 12px;
            transition: 0.4s; width: 90%; max-width: 400px;
        }
        #status-bar.show { transform: translateX(-50%) translateY(env(safe-area-inset-top)); }
        
        /* Optimierter Lösch-Button für Handy */
        #del-btn { 
            display: none; 
            padding: 12px;
            margin-left: 10px;
            border-radius: 12px;
            background: rgba(186, 26, 26, 0.1); /* Zartes Rot im Hintergrund */
        }
    </style>
</head>
<body data-theme="forest">

<div id="status-bar">
    <span class="material-symbols-rounded">touch_app</span>
    <span style="flex-grow:1; font-size:14px">Material-Ort auf Karte wählen</span>
    <button onclick="cancelPicking()" style="background:none; border:none; color:white;"><span class="material-symbols-rounded">close</span></button>
</div>

<header>
    <span class="material-symbols-rounded" style="color:var(--md-sys-color-primary)">inventory_2</span>
    <h1>GeoMaterial</h1>
</header>

<div id="content-area">
    <div id="view-map" class="view active">
        <div id="map"></div>
        <div class="fab-container">
            <button class="fab" onclick="startPicking()"><span class="material-symbols-rounded">add_circle</span></button>
            <button class="fab" onclick="recenterMap()" style="background:white; color:#444;"><span class="material-symbols-rounded">near_me</span></button>
        </div>
    </div>
    
    <div id="view-logs" class="view">
        <div style="padding: 20px;">
            <h2 style="margin-bottom:15px">Verfügbare Materials</h2>
            <div id="logs-container">Lade Materials...</div>
        </div>
    </div>

    <div id="view-settings" class="view">
        <div style="padding: 16px;">
            <div style="background:var(--md-sys-color-surface-variant); padding:20px; border-radius:24px; display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <div><strong>Satelliten-Karte</strong><br><small>Details aus der Luft</small></div>
                <label class="switch"><input type="checkbox" id="sat-toggle" onchange="toggleSatellite()"><span class="slider"></span></label>
            </div>
            <h3>Thema wählen</h3>
            <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px;">
                <button onclick="updateTheme('forest')" style="background:#2D6A4F; color:white; border:none; padding:15px; border-radius:15px;">Wald</button>
                <button onclick="updateTheme('ocean')" style="background:#006494; color:white; border:none; padding:15px; border-radius:15px;">Blau</button>
                <button onclick="updateTheme('volcano')" style="background:#9C4331; color:white; border:none; padding:15px; border-radius:15px;">Vulkan</button>
            </div>
            <div style="margin-top:30px; font-size:10px; opacity:0.3; text-align:center;">Geräte-ID: <span id="dev-id-display"></span></div>
        </div>
    </div>
</div>

<nav>
    <button class="nav-btn active" id="nav-map" onclick="navigateTo('map')"><div class="nav-icon-wrapper"><span class="material-symbols-rounded">map</span></div><span>Karte</span></button>
    <button class="nav-btn" id="nav-logs" onclick="navigateTo('logs')"><div class="nav-icon-wrapper"><span class="material-symbols-rounded">chat_bubble</span></div><span>Feed</span></button>
    <button class="nav-btn" id="nav-settings" onclick="navigateTo('settings')"><div class="nav-icon-wrapper"><span class="material-symbols-rounded">settings</span></div><span>Optionen</span></button>
</nav>

<div class="overlay" id="add-modal">
    <div class="modal">
        <h2 style="margin-top:0">Neues Material</h2>
        <input type="text" id="new-name" class="m3-field" placeholder="Name des Materials">
        <textarea id="new-desc" class="m3-field" placeholder="Kurze Info dazu..." rows="3"></textarea>
        <button class="btn-main" id="btn-save-mat">Eintragen</button>
        <button onclick="closeAddModal()" style="width:100%; background:none; border:none; padding:15px; color:#666;">Abbrechen</button>
    </div>
</div>

<div class="overlay" id="detail-overlay">
    <div class="modal">
        <div style="display:flex; align-items:center; margin-bottom:10px;">
            <h2 id="m-name" style="margin:0; flex-grow:1; font-size: 24px;"></h2>
            <button id="del-btn" style="border:none; color:var(--md-sys-color-error);"><span class="material-symbols-rounded" style="font-size: 30px;">delete</span></button>
        </div>
        <p id="m-desc" style="opacity:0.8; margin-bottom:20px; font-size: 16px;"></p>
        <div id="comment-list" style="max-height:150px; overflow-y:auto; background:rgba(0,0,0,0.03); border-radius:15px; padding:15px; margin-bottom:15px;"></div>
        <input type="text" id="reply-text" class="m3-field" placeholder="Kommentar schreiben...">
        <button class="btn-main" id="btn-reply">Absenden</button>
        <button onclick="closeDetailModal()" style="width:100%; background:none; border:none; padding:15px;">Schließen</button>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, serverTimestamp, doc, updateDoc, arrayUnion, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDYGCVoCDS5vymZPsFGLuW4NAco02Df0kA",
        authDomain: "matirial-geo.firebaseapp.com",
        projectId: "matirial-geo",
        storageBucket: "matirial-geo.firebasestorage.app",
        messagingSenderId: "418735123994",
        appId: "1:418735123994:web:616d9e68a89d13a1e16ba3"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const pinsCol = collection(db, "pins");

    let myId = localStorage.getItem('geo_device_id');
    if(!myId) {
        myId = 'dev_' + Math.random().toString(36).substr(2, 9);
        localStorage.setItem('geo_device_id', myId);
    }
    document.getElementById('dev-id-display').innerText = myId;

    let map, activeMaterialId, userMarker, tempCoords;
    const osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png');
    const satLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}');

    map = L.map('map', { zoomControl: false, layers: [osmLayer], attributionControl: false }).setView([48.2, 13.0], 10);

    onSnapshot(query(pinsCol, orderBy("createdAt", "desc")), (snapshot) => {
        const mats = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
        renderMarkers(mats);
        renderFeed(mats);
    });

    window.navigateTo = (v) => {
        document.querySelectorAll('.view').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));
        document.getElementById('view-'+v).classList.add('active');
        document.getElementById('nav-'+v).classList.add('active');
        if(v === 'map') setTimeout(() => map.invalidateSize(), 300);
    };

    window.toggleSatellite = () => {
        if(document.getElementById('sat-toggle').checked) { map.removeLayer(osmLayer); map.addLayer(satLayer); }
        else { map.removeLayer(satLayer); map.addLayer(osmLayer); }
    };

    window.updateTheme = (t) => document.body.setAttribute('data-theme', t);

    window.startPicking = () => {
        document.getElementById('status-bar').classList.add('show');
        map.once('click', (e) => {
            tempCoords = e.latlng;
            document.getElementById('add-modal').classList.add('show');
            cancelPicking();
        });
    };

    window.cancelPicking = () => document.getElementById('status-bar').classList.remove('show');

    // MOBILE OPTIMIERTE CLICK HANDLER
    document.getElementById('btn-save-mat').addEventListener('touchend', async (e) => {
        e.preventDefault();
        const name = document.getElementById('new-name').value;
        const desc = document.getElementById('new-desc').value;
        if(name && tempCoords) {
            await addDoc(pinsCol, { 
                name, desc, lat: tempCoords.lat, lng: tempCoords.lng, 
                comments: [], createdAt: serverTimestamp(), ownerId: myId 
            });
            document.getElementById('new-name').value = '';
            document.getElementById('new-desc').value = '';
            closeAddModal();
        }
    });

    document.getElementById('del-btn').addEventListener('touchend', async (e) => {
        e.preventDefault();
        if(activeMaterialId) {
            if(confirm("Soll dieses Material wirklich gelöscht werden?")) {
                await deleteDoc(doc(db, "pins", activeMaterialId));
                closeDetailModal();
            }
        }
    });

    document.getElementById('btn-reply').addEventListener('touchend', async (e) => {
        e.preventDefault();
        const text = document.getElementById('reply-text').value;
        if(text && activeMaterialId) {
            await updateDoc(doc(db, "pins", activeMaterialId), { comments: arrayUnion(text) });
            document.getElementById('reply-text').value = '';
        }
    });

    function renderMarkers(mats) {
        map.eachLayer(l => { if(l instanceof L.Marker && l !== userMarker) map.removeLayer(l); });
        mats.forEach(p => {
            const icon = L.divIcon({ 
                className:'', 
                html:`<div style="background:var(--md-sys-color-primary); color:white; border:2px solid white; width:36px; height:36px; border-radius:50% 50% 50% 0; transform:rotate(-45deg); display:flex; align-items:center; justify-content:center; box-shadow:0 3px 6px rgba(0,0,0,0.2);"><span class="material-symbols-rounded" style="transform:rotate(45deg); font-size:20px;">inventory_2</span></div>`, 
                iconSize:[36,36], iconAnchor:[18,36] 
            });
            L.marker([p.lat, p.lng], {icon}).addTo(map).on('click', () => openPin(p));
        });
    }

    window.openPin = (p) => {
        activeMaterialId = p.id;
        document.getElementById('m-name').innerText = p.name;
        document.getElementById('m-desc').innerText = p.desc || '';
        
        const delBtn = document.getElementById('del-btn');
        if(p.ownerId === myId) {
            delBtn.style.display = 'block';
        } else {
            delBtn.style.display = 'none';
        }

        document.getElementById('comment-list').innerHTML = p.comments.length > 0 ? p.comments.map(c => `<div style="padding:12px 0; border-bottom:1px solid rgba(0,0,0,0.05); font-size:15px;">${c}</div>`).join('') : 'Keine Kommentare.';
        document.getElementById('detail-overlay').classList.add('show');
    };

    window.recenterMap = () => {
        navigator.geolocation.getCurrentPosition(pos => {
            const coords = [pos.coords.latitude, pos.coords.longitude];
            if(!userMarker) {
                userMarker = L.marker(coords, { icon: L.divIcon({ html: '<div style="width:18px; height:18px; background:#4285F4; border:3px solid white; border-radius:50%; box-shadow:0 0 10px rgba(0,0,0,0.3);"></div>', className:'' }) }).addTo(map);
            } else {
                userMarker.setLatLng(coords);
            }
            map.flyTo(coords, 16);
        }, () => alert("Bitte Standortzugriff erlauben"), { enableHighAccuracy: true });
    };

    window.closeAddModal = () => document.getElementById('add-modal').classList.remove('show');
    window.closeDetailModal = () => document.getElementById('detail-overlay').classList.remove('show');

    function renderFeed(mats) {
        document.getElementById('logs-container').innerHTML = mats.map(p => `
            <div style="background:var(--md-sys-color-surface-variant); padding:20px; border-radius:24px; margin-bottom:12px;" onclick='openPin(${JSON.stringify(p).replace(/'/g, "&apos;")})'>
                <div style="font-weight:700; font-size: 18px;">${p.name}</div>
                <div style="font-size:13px; opacity:0.6; margin-top:4px;">${p.comments.length} Antworten</div>
            </div>
        `).join('');
    }
</script>
</body>
</html>
